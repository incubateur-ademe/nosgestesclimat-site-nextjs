name: E2E Tests

on:
  pull_request:
  push:
    branches:
      - main
      - preprod

env:
  NEXT_PUBLIC_SERVER_URL: ${{ vars.NEXT_PUBLIC_SERVER_URL }}
  NEXT_PUBLIC_PROXY_SERVER: 'true'
  LOCAL_TEST: ${{ github.event.inputs.branch != 'preprod' && 'true' || 'false' }}
  NEXT_PUBLIC_SITE_URL: ${{ github.event.inputs.branch == 'preprod' && 'https://preprod.nosgestesclimat.fr' || 'http://localhost:3000' }}

jobs:
  # Build and setup job - runs on a single machine
  build-and-setup:
    environment: 'Test E2E'
    runs-on: ubuntu-latest
    name: Build & Setup Tests

    steps:
      - uses: actions/checkout@v6
      - name: Setup and Build
        uses: ./.github/actions/setup
        with:
          build: ${{ env.LOCAL_TEST }}

      - name: Install Playwright
        run: pnpm playwright install chromium

      - name: Run setup tests
        env:
          MAILISK_API_KEY: ${{ secrets.MAILISK_API_KEY }}
          MAILISK_NAMESPACE: ${{ vars.MAILISK_NAMESPACE }}
          CMS_TOKEN: ${{ secrets.CMS_TOKEN }}
          CMS_URL: ${{ secrets.CMS_URL }}
        run: |
          ${{ env.LOCAL_TEST && 'pnpm start &' || '' }}
          pnpm playwright test --project="global setup"

      - name: Upload state artifacts
        uses: actions/upload-artifact@v6
        with:
          name: e2e-state
          path: e2e/state/*.json
          retention-days: 1

      # We archive the Next.js build because ":" in filenames are not allowed by upload-artifact
      - name: Archive Next.js build
        if: ${{ env.LOCAL_TEST }}
        run: tar -cf nextjs-build.tar .next

      - name: Upload Next.js build
        if: ${{ env.LOCAL_TEST }}
        uses: actions/upload-artifact@v6
        with:
          name: nextjs-build
          path: nextjs-build.tar
          retention-days: 1

  # Project-based test jobs - runs on 3 machines in parallel
  e2e-tests:
    environment: 'Test E2E'
    needs: [build-and-setup]
    strategy:
      fail-fast: false
      matrix:
        include:
          - project: Chrome
            browser: chromium
          - project: Firefox
            browser: firefox
          - project: Mobile Safari
            browser: webkit
    runs-on: ubuntu-latest
    name: E2E ${{ matrix.project }}

    steps:
      - uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Download Next.js build
        if: ${{ env.LOCAL_TEST }}
        uses: actions/download-artifact@v6
        with:
          name: nextjs-build

      - name: Extract Next.js build
        if: ${{ env.LOCAL_TEST }}
        run: tar -xf nextjs-build.tar

      - name: Install Playwright
        run: pnpm playwright install ${{ matrix.browser }} ${{ matrix.browser == 'webkit' && '--with-deps' || '' }}

      - name: Download state artifacts
        uses: actions/download-artifact@v6
        with:
          name: e2e-state
          path: e2e/state

      - name: Run E2E tests (${{ matrix.project }})
        env:
          MAILISK_API_KEY: ${{ secrets.MAILISK_API_KEY }}
          MAILISK_NAMESPACE: ${{ vars.MAILISK_NAMESPACE }}
          CMS_TOKEN: ${{ secrets.CMS_TOKEN }}
          CMS_URL: ${{ secrets.CMS_URL }}
        run: |
          ${{ env.LOCAL_TEST && 'pnpm start &' || ''}}
          pnpm playwright test --no-deps --project="${{ matrix.project }}"

      - name: Upload blob report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: blob-report-${{ matrix.project }}
          path: blob-report
          retention-days: 1

  # Merge reports from all shards
  merge-reports:
    if: ${{ !cancelled() }}
    needs: [e2e-tests]
    runs-on: ubuntu-latest
    name: Merge E2E Reports

    steps:
      - uses: actions/checkout@v6

      - name: Download blob reports
        uses: actions/download-artifact@v6
        with:
          path: all-blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: Merge into HTML Report
        run: npx playwright merge-reports --reporter html ./all-blob-reports

      - name: Upload HTML report
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
