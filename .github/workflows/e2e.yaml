name: E2E Tests

on:
  push:
    branches:
      - preprod
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test'
        required: true
        type: string

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.14'

      - name: Install dependencies
        run: yarn install

      # - name: Generate E2E test specs from personas
      #   run: yarn e2e:generate

      - name: Get PR number for non-main/preprod branches
        if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.branch != 'preprod') || (github.event_name == 'push' && github.ref != 'refs/heads/preprod') || (github.event_name == 'pull_request' && github.head_ref != 'preprod') }}
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            // For workflow_dispatch events, we need to find the PR for the specified branch
            if (context.eventName === 'workflow_dispatch') {
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: context.repo.owner + ':' + '${{ github.event.inputs.branch }}',
                sort: 'created',
                direction: 'desc'
              });
              if (prs.data.length > 0) {
                return prs.data[0].number;
              }
              return '';
            }
            // For pull_request events, we can get the PR number directly
            if (context.payload.pull_request) {
              return context.payload.pull_request.number;
            }
            // Fallback: try to find PR by current branch
            const currentBranch = context.ref.replace('refs/heads/', '');
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: context.repo.owner + ':' + currentBranch,
              sort: 'created',
              direction: 'desc'
            });
            if (prs.data.length > 0) {
              return prs.data[0].number;
            }
            return '';

      - name: Set test URL
        id: set-url
        run: |
          if [ "${{ github.event.inputs.branch }}" = "preprod" || (github.event_name == 'push' && github.ref == 'refs/heads/preprod') ]; then
            echo "TEST_URL=https://preprod.nosgestesclimat.fr" >> $GITHUB_ENV
          else
            PR_NUMBER=${{ steps.pr.outputs.result }}
            if [ -n "$PR_NUMBER" ]; then
              echo "TEST_URL=https://nosgestesclimat-site-preprod-pr$PR_NUMBER.osc-fr1.scalingo.io" >> $GITHUB_ENV
            else
              echo "No PR found for branch ${{ github.event.inputs.branch }}" >&2
              exit 1
            fi
          fi

      - name: Set CYPRESS_baseUrl
        run: echo "CYPRESS_baseUrl=${{ env.TEST_URL }}" >> $GITHUB_ENV

      - name: Run E2E tests
        run: |
          echo "Running tests against ${{ env.TEST_URL }}"
          yarn e2e:ci
